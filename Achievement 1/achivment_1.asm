.include "m8def.inc"

; Определение констант
.equ F_CPU = 1000000  
.equ BAUD = 9600 
.equ TIMER1_INTERVAL = 1000 
.equ TIMER2_INTERVAL = 2000

; Определение строк
TIMER1_STR:	.db "ping", 0
TIMER2_STR:	.db "pong", 0 

; Регистры
.def temp = r16 ;
.def timer1_high = r17
.def timer1_low = r18 
.def timer2 = r19 

; Флаги
.def timer1_updated = r20 
.def timer2_updated = r21

; Указатели
.def str_ptr = r22 
.def str_len = r23 

; Прерывание таймера 1
.org OVF1addr
rjmp TIMER1_ISR

; Прерывание таймера 2
.org OVF2addr
rjmp TIMER2_ISR

; Инициализация USART
init_usart:
	ldi temp, low(-(F_CPU/(BAUD*16))) 
	sts UBRRH, temp 
	ldi temp, low(-(F_CPU/(BAUD*16)))
	sts UBRRL, temp 
	ldi temp, (1<<RXEN)|(1<<TXEN) 
	sts UCSRB, temp
	ldi temp, (1<<UCSZ1)|(1<<UCSZ0) 
	sts UCSRC, temp
	ret

; Функция передачи символа через USART
transmit_char:
	sts UDR, temp 
loop_until_bit_is_set:
	sbis UCSRA, UDRE 
	rjmp loop_until_bit_is_set 
	ret

; Функция передачи строки через USART
transmit_string:
	ldi str_ptr, 0 
next_char:
	ld temp, Z+
	cp temp, 0 
	breq end_transmit 
	call transmit_char 
	rjmp next_char
end_transmit:
	ret

; Инициализация таймеров
init_timers:
	ldi temp, (1<<TOIE1)|(1<<TOIE2)
	sts TIMSK, temp 
	ldi temp, (1<<CS10) 
	sts TCCR1B, temp 
	sts TCCR2, temp 
	ret

; Функция изменения значения таймера 1
set_timer1_interval:
	lds timer1_low, Z+
	lds timer1_high, Z+ 
	ldi timer1_updated, 1 
	ret

; Функция изменения значения таймера 2
set_timer2_interval:
	lds timer2, Z+ 
	ldi timer2_updated, 1
	ret

; Функция перезапуска таймеров
restart_timers:
	ldi temp, (1<<TOV1) ; Сброс флага переполнения таймера 1
	sts TIFR, temp
	ldi temp, (1<<TOV2) ; Сброс флага переполнения таймера 2
	sts TIFR, temp
	ret

; Функция изменения строки для таймера 1
set_timer1_string:
	ldi str_ptr, 0
	ldi str_len, 0 
next_char1:
	lds temp, Z+ 
	cp temp, 0 
	breq end_set_timer1_string 
	sts TIMER1_STR + str_len, temp
	inc str_len 
	rjmp next_char1 
